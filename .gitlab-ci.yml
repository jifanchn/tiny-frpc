# GitLab CI/CD Configuration for tiny-frpc
# Builds demo binaries for Linux, macOS (Intel + Apple Silicon), and Windows
# Creates releases automatically when tags are pushed

stages:
  - build
  - test
  - release

variables:
  PROJECT_NAME: tiny-frpc-demo

# ============================================================================
# Build Stage - Cross-platform compilation
# ============================================================================

# --- Linux amd64 ---
build:linux-amd64:
  stage: build
  image: gcc:latest
  script:
    - apt-get update && apt-get install -y make
    - make all
    - make demo-stcp
    - mkdir -p artifacts/linux-amd64
    - cp build/demo_stcp_frps artifacts/linux-amd64/
    - cp build/demo_stcp_server artifacts/linux-amd64/
    - cp build/demo_stcp_visitor artifacts/linux-amd64/
    - cp build/demo_stcp_local_client artifacts/linux-amd64/
    - cp demo/stcp/README.md artifacts/linux-amd64/
    - cd artifacts && tar -czvf ${PROJECT_NAME}-linux-amd64.tar.gz linux-amd64
  artifacts:
    name: "${PROJECT_NAME}-linux-amd64"
    paths:
      - artifacts/${PROJECT_NAME}-linux-amd64.tar.gz
    expire_in: 1 week

# --- macOS amd64 (Intel) ---
build:darwin-amd64:
  stage: build
  tags:
    - macos
    - amd64
  script:
    - make all
    - make demo-stcp
    - mkdir -p artifacts/darwin-amd64
    - cp build/demo_stcp_frps artifacts/darwin-amd64/
    - cp build/demo_stcp_server artifacts/darwin-amd64/
    - cp build/demo_stcp_visitor artifacts/darwin-amd64/
    - cp build/demo_stcp_local_client artifacts/darwin-amd64/
    - cp demo/stcp/README.md artifacts/darwin-amd64/
    - cd artifacts && tar -czvf ${PROJECT_NAME}-darwin-amd64.tar.gz darwin-amd64
  artifacts:
    name: "${PROJECT_NAME}-darwin-amd64"
    paths:
      - artifacts/${PROJECT_NAME}-darwin-amd64.tar.gz
    expire_in: 1 week

# --- macOS arm64 (Apple Silicon) ---
build:darwin-arm64:
  stage: build
  tags:
    - macos
    - arm64
  script:
    - make all
    - make demo-stcp
    - mkdir -p artifacts/darwin-arm64
    - cp build/demo_stcp_frps artifacts/darwin-arm64/
    - cp build/demo_stcp_server artifacts/darwin-arm64/
    - cp build/demo_stcp_visitor artifacts/darwin-arm64/
    - cp build/demo_stcp_local_client artifacts/darwin-arm64/
    - cp demo/stcp/README.md artifacts/darwin-arm64/
    - cd artifacts && tar -czvf ${PROJECT_NAME}-darwin-arm64.tar.gz darwin-arm64
  artifacts:
    name: "${PROJECT_NAME}-darwin-arm64"
    paths:
      - artifacts/${PROJECT_NAME}-darwin-arm64.tar.gz
    expire_in: 1 week

# --- Windows amd64 (cross-compile from Linux) ---
build:windows-amd64:
  stage: build
  image: debian:bullseye
  script:
    - apt-get update && apt-get install -y make gcc-mingw-w64-x86-64 zip
    - |
      cat > mingw.mk << 'EOF'
      CC = x86_64-w64-mingw32-gcc
      LDFLAGS += -static -lpthread
      EOF
    - make CC=x86_64-w64-mingw32-gcc LDFLAGS="-static" all
    - make CC=x86_64-w64-mingw32-gcc LDFLAGS="-static" demo-stcp || true
    - mkdir -p artifacts/windows-amd64
    - |
      for f in demo_stcp_frps demo_stcp_server demo_stcp_visitor demo_stcp_local_client; do
        if [ -f "build/$f" ]; then
          cp "build/$f" "artifacts/windows-amd64/${f}.exe"
        elif [ -f "build/${f}.exe" ]; then
          cp "build/${f}.exe" "artifacts/windows-amd64/"
        fi
      done
    - cp demo/stcp/README.md artifacts/windows-amd64/
    - cd artifacts && zip -r ${PROJECT_NAME}-windows-amd64.zip windows-amd64
  artifacts:
    name: "${PROJECT_NAME}-windows-amd64"
    paths:
      - artifacts/${PROJECT_NAME}-windows-amd64.zip
    expire_in: 1 week

# ============================================================================
# Test Stage
# ============================================================================

test:linux:
  stage: test
  image: golang:1.21
  needs: ["build:linux-amd64"]
  script:
    - apt-get update && apt-get install -y gcc make
    - make install
    - make test
  allow_failure: true

# ============================================================================
# Release Stage - Triggered on tags (e.g., v1.0.0)
# ============================================================================

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:linux-amd64
      artifacts: true
    - job: build:darwin-amd64
      artifacts: true
      optional: true
    - job: build:darwin-arm64
      artifacts: true
      optional: true
    - job: build:windows-amd64
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creating release for tag $CI_COMMIT_TAG"
    - ls -la artifacts/
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## tiny-frpc $CI_COMMIT_TAG
      
      Cross-platform STCP demo binaries.
      
      ### Downloads
      | Platform | Architecture | File |
      |----------|--------------|------|
      | Linux | amd64 | `${PROJECT_NAME}-linux-amd64.tar.gz` |
      | macOS | amd64 (Intel) | `${PROJECT_NAME}-darwin-amd64.tar.gz` |
      | macOS | arm64 (Apple Silicon) | `${PROJECT_NAME}-darwin-arm64.tar.gz` |
      | Windows | amd64 | `${PROJECT_NAME}-windows-amd64.zip` |
      
      ### Usage
      See `README.md` in the archive for usage instructions.
    assets:
      links:
        - name: "Linux amd64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/artifacts/${PROJECT_NAME}-linux-amd64.tar.gz?job=build:linux-amd64"
          link_type: package
        - name: "macOS amd64 (Intel)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/artifacts/${PROJECT_NAME}-darwin-amd64.tar.gz?job=build:darwin-amd64"
          link_type: package
        - name: "macOS arm64 (Apple Silicon)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/artifacts/${PROJECT_NAME}-darwin-arm64.tar.gz?job=build:darwin-arm64"
          link_type: package
        - name: "Windows amd64"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/artifacts/${PROJECT_NAME}-windows-amd64.zip?job=build:windows-amd64"
          link_type: package
